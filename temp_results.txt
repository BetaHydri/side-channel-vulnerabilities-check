
=== Side-Channel Vulnerability Configuration Check ===
Based on Microsoft KB4073119 - Core Documented Mitigations

IMPORTANT: This script checks only the core KB4073119 documented mitigations.
For comprehensive analysis including modern CVEs (2022-2023), also run:
   Install-Module SpeculationControl; Get-SpeculationControlSettings

*** PERFORMANCE IMPACT WARNING ***
Some mitigations may significantly impact system performance:
- L1TF & MDS Mitigations: May require disabling hyperthreading
- Older Hyper-V (pre-2016): Higher performance impact
- VBS/Credential Guard: Requires UEFI, Secure Boot, TPM 2.0
- Build servers/shared hosting: May need SMT disabled
Test performance impact in non-production first!

System Information:
CPU: 11th Gen Intel(R) Core(TM) i7-11370H @ 3.30GHz
OS: Microsoft Windows 11 Enterprise Build 26200
Architecture: 64-bit

Virtualization Environment:
Running in VM: No
Hyper-V Status: Enabled
VBS Status: Running
HVCI Status: Enforced
Nested Virtualization: Disabled
Checking Side-Channel Vulnerability Mitigations...

Speculative Store Bypass Disable              : [+] ENABLED (Value: 72)
SSBD Feature Mask                             : [+] ENABLED (Value: 3)
Branch Target Injection Mitigation            : [+] ENABLED (Value: 0)
Kernel VA Shadow (Meltdown Protection)        : [+] ENABLED (Value: 1)
Hardware Security Mitigations                 : [+] ENABLED (Value: 2305843009213694208)
Exception Chain Validation                    : [+] ENABLED (Value: 0)
Supervisor Mode Access Prevention             : [+] ENABLED (Value: 1)
Intel TSX Disable                             : [+] ENABLED (Value: 1)
Enhanced IBRS                                 : [+] ENABLED (Value: 1)

Checking Additional CVE Mitigations (Performance Impact Warning)...
L1TF Mitigation                               : [-] NOT SET
MDS Mitigation                                : [-] NOT SET
CVE-2019-11135 Mitigation                     : [+] ENABLED (Value: 1)
SBDR/SBDS Mitigation                          : [+] ENABLED (Value: 1)
SRBDS Update Mitigation                       : [+] ENABLED (Value: 1)
DRPW Mitigation                               : [+] ENABLED (Value: 1)

Checking Windows Security Features...

Checking Virtualization-Specific Security Features...

Hypervisor Host-Specific Security Checks:


DETAILED SECURITY ANALYSIS
=

Virtualization Based Security Detailed Status:
=================================================

VBS (Virtualization Based Security):
  Hardware Ready:  - No
  Currently Active: + Yes

HVCI (Hypervisor-protected Code Integrity):
  Hardware Ready:  - No
  Currently Active: + Yes

NOTE: VBS is running despite hardware readiness showing 'No'.
   This indicates VBS is enabled via software/policy, not full hardware support.

NOTE: HVCI is active despite hardware readiness showing 'No'.
   This indicates HVCI is using compatible mode or software enforcement.

Security Services Details:
Running Services: 1, 2
Configured Services: 1, 2

Active Security Services:
  - Credential Guard
  - HVCI (Hypervisor-protected Code Integrity)


VBS/HVCI Status Explanation:
-
- 'Hardware Ready' = System meets full hardware requirements
- 'Currently Active' = Feature is actually running right now

Why might Hardware Ready = No but Active = Yes?
1. VBS/HVCI can run in 'compatible mode' without full HW support
2. Some hardware requirements are optional for basic functionality
3. Software-based enforcement may be enabled via Group Policy
4. The hardware readiness check may be overly strict

[+] What matters: If 'Currently Active' = Yes, protection is working!


HARDWARE SECURITY MITIGATION VALUE MATRIX
=

The Hardware Security Mitigations (MitigationOptions) registry value is a bit-field
that controls various CPU-level security features. Here's what the flags mean:

Common Hardware Mitigation Flags:
=================================

Flag Value          Status    Mitigation Name
----------          ------    ---------------
0x0000000000020000  -       Non-System Font Disable
0x0000000000040000  -       Audit Non-System Font Loading
0x0000000000080000  -       Child Process Policy
0x0000000000004000  -       Module Signature Enforcement
0x0000000000008000  -       Font Disable
0x0000000000010000  -       Image Load Signature Mitigation
0x0000000004000000  -       CET Dynamic Code
0x0000000008000000  -       Intel MPX (Memory Protection Extensions)
0x2000000000000000  +       Core Hardware Security Features
                               --> This is the primary flag for side-channel mitigations!
0x0000000000100000  -       Payload Restriction Policy
0x0000000001000000  -       CET (Intel CET Shadow Stack)
0x0000000002000000  -       CET Strict Mode
0x0000000000002000  -       Import Address Filtering
0x0000000000000008  -       DEP (Data Execution Prevention)
0x0000000000000010  -       DEP ATL Thunk Emulation
0x0000000000000020  -       SEHOP (SEH Overwrite Protection)
0x0000000000000001  -       CFG (Control Flow Guard)
0x0000000000000002  -       CFG Export Suppression
0x0000000000000004  -       CFG Strict Mode
0x0000000000000200  -       Force Relocate Images
0x0000000000000400  -       Heap Terminate on Corruption (Enhanced)
0x0000000000001000  -       Stack Pivot Protection
0x0000000000000040  -       Heap Terminate on Corruption
0x0000000000000080  -       Bottom-up ASLR
0x0000000000000100  +       High Entropy ASLR

Current MitigationOptions Value:
Hex:     0x2000000000000100
Enabled: 2 of 25 known flags

Recommended Minimum Value:
0x2000000000000000 (Core Hardware Security Features)

Note: The exact flags enabled depend on your CPU capabilities and Windows version.
Some flags are only available on newer processors or Windows versions.

=== Side-Channel Vulnerability Mitigation Status ===

Mitigation Name                            Status                                          Current Value
---------------                            ------                                          -------------
Speculative Store Bypass Disable           [+] Enabled                                                72
SSBD Feature Mask                          [+] Enabled                                                 3
Branch Target Injection Mitigation         [+] Enabled                                                 0
Kernel VA Shadow (Meltdown Protection)     [+] Enabled                                                 1
Hardware Security Mitigations              [+] Enabled                                0x2000000000000100
Exception Chain Validation                 [+] Enabled                                                 0
Supervisor Mode Access Prevention          [+] Enabled                                                 1
Intel TSX Disable                          [+] Enabled                                                 1
Retpoline Support                          Information              Check with compiler and application 
                                                                                                 vendors
Enhanced IBRS                              [+] Enabled                                                 1
L1TF Mitigation                            [-] Not Set                                           Not Set
MDS Mitigation                             [-] Not Set                                           Not Set
CVE-2019-11135 Mitigation                  [+] Enabled                                                 1
SBDR/SBDS Mitigation                       [+] Enabled                                                 1
SRBDS Update Mitigation                    [+] Enabled                                                 1
DRPW Mitigation                            [+] Enabled                                                 1
Windows Defender Exploit Guard ASLR        [-] Not Set                                           Not Set
Virtualization Based Security (VBS)        [+] Enabled                                                 1
UEFI Firmware (not Legacy BIOS)            UEFI Firmware Active                     Modern UEFI firmware
Secure Boot                                [+] Enabled                                            Active
TPM 2.0 (Trusted Platform Module)          TPM 2.0 Enabled                 Version 2.0, 0, 1.38 - Active
CPU Virtualization Support (VT-x/AMD-V)    Enabled and Active             Hardware virtualization active
IOMMU/VT-d Support                         Enabled and Active                        Available (Hyper-V)
Hypervisor-protected Code Integrity (HVCI) [+] Enabled                                                 1
Credential Guard                           [+] Enabled                                                 1
Hyper-V Core Scheduler                     [+] Enabled                                        OS Default
Nested Virtualization Security             [-] Disabled                                         Disabled



Status Legend:
[+] Enabled - Mitigation is active and properly configured
[-] Disabled - Mitigation is explicitly disabled
[-] Not Set - Registry value not configured (using defaults)

=== SECURITY CONFIGURATION SUMMARY ===

Security Status Overview:
=========================
[+] ENABLED:       18 / 27 mitigations
[-] NOT SET:       3 / 27 mitigations
[-] DISABLED:       / 27 mitigations

Overall Security Level: 66.7%
Security Bar:     [######----] 66.7%

=== Recommendations ===
The following mitigations should be configured:
- L1TF Mitigation: Enable L1TF protection. WARNING: High performance impact in virtualized environments
- MDS Mitigation: Enable MDS protection. WARNING: Moderate performance impact on Intel CPUs
- Windows Defender Exploit Guard ASLR: Enable ASLR force relocate images for better security
- Nested Virtualization Security: Use nested virtualization carefully - additional attack surface

To apply these configurations automatically, run:
.\SideChannel_Check.ps1 -Apply

For interactive selection (recommended):
.\SideChannel_Check.ps1 -Apply -Interactive

Or manually use these registry commands:
(Filtered for GenuineIntel CPU compatibility)
reg add "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\kernel" /v "L1TFMitigationLevel" /t REG_DWORD /d 1 /f
reg add "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\kernel" /v "MDSMitigationLevel" /t REG_DWORD /d 1 /f
reg add "HKLM:\SOFTWARE\Microsoft\Windows Defender\Windows Defender Exploit Guard\Exploit Protection\System" /v "ASLR_ForceRelocateImages" /t REG_DWORD /d 1 /f

Note: A system restart may be required after making registry changes.
These are the core KB4073119 documented mitigations. For additional modern CVE mitigations,
use Microsoft's official SpeculationControl PowerShell module.

=== Virtualization Security Recommendations ===

Status Symbols:
[+] Enabled/Recommended - Feature is active or recommended configuration
[-] Disabled/Not Recommended - Feature is disabled or not recommended
[-] Unknown/Variable - Status depends on configuration or hardware
Running on Physical Hardware - Host Recommendations:
- Apply CPU microcode updates from manufacturer
- Enable all available CPU security features in BIOS/UEFI

Hyper-V Host Specific:
- Core Scheduler: [+] Enabled by default (Windows 11/Server 2022+ Build 26200)
- Configure VM isolation policies
- Use Generation 2 VMs for enhanced security
- Enable Secure Boot for VMs when possible
- Consider disabling SMT if security > performance

General Host Security:
- Enable VBS/HVCI if hardware supports it
- Use UEFI Secure Boot
- Enable TPM 2.0 if available
- Configure proper VM resource isolation

=== Hardware Prerequisites for Side-Channel Protection ===
Hardware Security Assessment:
(Symbols: [+] Enabled/Good, [-] Needs Verification, [-] Disabled/Missing)
- UEFI Firmware: + UEFI Firmware Active
- Secure Boot: + Enabled
- TPM 2.0: [+] TPM 2.0 Enabled
- CPU Virtualization (VT-x/AMD-V): + Enabled and Active
- IOMMU/VT-d Support: + Enabled and Active

Required CPU Features:
- Intel: VT-x with EPT, VT-d (or AMD: AMD-V with RVI, AMD-Vi)
- Hardware support for SMEP/SMAP
- CPU microcode with Spectre/Meltdown mitigations
- For VBS: IOMMU, TPM 2.0, UEFI Secure Boot

Administrator Action Items:
===========================

Required Actions for Optimal Security:
- Update system firmware/BIOS to latest version for security fixes
- Update CPU microcode through Windows Update or vendor tools

Manual Verification Steps:
- Boot into UEFI/BIOS setup to verify settings
- Run 'msinfo32.exe' and check 'System Summary' for Secure Boot State
- Use 'tpm.msc' to verify TPM status and version
- Check Windows Event Logs for Hyper-V and VBS initialization

Firmware Requirements Status:
- UEFI firmware (not legacy BIOS): + Met
- Secure Boot capability: + Available
- TPM 2.0: [+] Present
- Latest firmware updates: ? Check with manufacturer

Side-channel vulnerability check completed.
